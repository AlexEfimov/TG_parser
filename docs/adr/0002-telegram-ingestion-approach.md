# ADR 0002 – Подход к Telegram Ingestion

## Статус
Accepted

## Контекст

Нужно надёжно и эффективно получать сообщения из Telegram‑каналов с учётом:
- лимитов Telegram API;
- работы с историей и новыми сообщениями;
- потенциального расширения на большое количество каналов.

## Решение

- Использовать выделенный модуль `ingestion.telegram`, инкапсулирующий все детали клиента/библиотеки.
- **Telegram‑клиент (зафиксировано)**: `Telethon` (MTProto) как основной способ чтения истории и новых сообщений каналов/обсуждений.
- Хранить позицию/offset по каждому каналу, чтобы обеспечивать идемпотентность и продолжение после сбоев.
- Нормализовать сообщения в формат `RawTelegramMessage` сразу при приёме.
- Реализация ingestion выполняется в `asyncio` (нативный режим работы Telethon) и должна поддерживать параллельную обработку нескольких источников.
- Обеспечить конфигурируемые стратегии:
  - «исторический» прогон (backfill);
  - «онлайн» режим (только новые сообщения).
- Сбор комментариев должен быть опциональным параметром источника (например, `include_comments: true/false`). Для комментариев в MVP рекомендуется per‑post курсор (прогресс хранится отдельно для каждого треда/поста).
- Период backfill для источника должен задаваться параметрами `history_from/history_to` (date-time). Курсоры (например, `last_post_id` и per‑post `last_comment_id`) должны обновляться только после успешной записи raw‑данных, чтобы гарантировать возобновляемость и идемпотентность.
- Для надёжности ingestion в MVP должны быть определены статусы источника (`active/paused/error`) и политика retry: retryable ошибки обрабатываются экспоненциальным backoff + jitter (с лимитом попыток за запуск), non‑retryable переводят источник в `error` до ручного вмешательства.
- Состояние ingestion (источники, статусы, курсоры/offset’ы, per‑post курсоры комментариев) в MVP рекомендуется хранить в локальном SQLite‑хранилище для атомарности и возобновляемости.
- Raw‑данные в MVP рекомендуется хранить в отдельном SQLite‑хранилище (отдельный файл от ingestion state) с уникальностью по `source_ref`. Медиа‑вложения на этапе I не скачиваются: сохраняются только метаданные/ссылки. Для `raw_payload` вводится лимит размера (например 256KB) с мягким truncation для предотвращения разрастания хранилища.

## Последствия

- Ingestion можно развивать и масштабировать независимо от остальной части пайплайна.
- Можно добавить альтернативные реализации (другой клиент/библиотека) при сохранении контракта `RawTelegramMessage`.

## Ссылки

- Выбранный стек (язык/Telegram/LLM/хранилище): `docs/tech-stack.md`


